<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Morphogenetics - KiloGuide</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Morphogenetics";
    var mkdocs_page_input_path = "tutorials/tuto4.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> KiloGuide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Guides</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../guides/guide-index.html">Guides summary</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../guides/getting-started.html">Getting started</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../guides/coding-for-kilobots.html">Coding for kilobots</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../guides/compile-your-code.html">Compile your code</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../guides/transfer-and-run-your-program.html">Transfer and run your program</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../guides/use-the-debug-feature.html">Use the debug feature</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="tuto-index.html">Tutorials summary</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tuto1.html">Race Around the World</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tuto2.html">Full Metal Kilobot</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tuto3.html">King-o-bot's Games</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="tuto4.html">Morphogenetics</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#what-you-will-learn">What you will learn</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sources-program">Source's program</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#the-setup-function">The setup() function</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#other-functions">Other functions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cells-program">Cell's program</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#macros-message-and-setup">Macros, message and setup()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sending-and-receiving-messages">Sending and receiving messages</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-loop-function">The loop() function</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#put-it-all-together">Put it all together</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#we-are-done">We are done !</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tuto5.html">Rush Hour</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../about.html">About</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">KiloGuide</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Tutorials &raquo;</li>
        
      
    
    <li>Morphogenetics</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="morphogenetics">Morphogenetics</h1>
<p><a href="../resources/sources/morpho.zip"><em>source code of this tutorial</em></a></p>
<hr />
<h2 id="summary">Summary</h2>
<p>In most animals' bodies, some cells are able to feel their distance from other cells using chemicals propagation. The main use of this ability is to form complex shapes and tissues. The field of <em><a href="https://en.wikipedia.org/wiki/Morphogenetic_robotics">morphogenetic robotics</a></em> takes inspiration from this to develop self-organized communities of robots.</p>
<p>In this tutorial, we are going to develop a <em>very simplified</em> morphogenesis algorithm. It works with one 'source' kilobot and multiple 'cell' kilobots. Each 'cell' kilobot will be able to deduct its distance from the 'source' kilobot by communicating with its neighbors. The kilobots won't move, but they will use their LED to indicate their distance level.</p>
<hr />
<h2 id="what-you-will-learn">What you will learn</h2>
<ul>
<li>How to implement a basic collective behavior</li>
</ul>
<hr />
<h2 id="sources-program">Source's program</h2>
<p>The source kilobot is fairly simple. He will only send a message telling its level : 0. To recognize it from the other kilobots, we will set its LED to white.</p>
<h3 id="the-setup-function">The <code>setup()</code> function</h3>
<pre><code class="language-c">message_t message;

int level = 0;  // 0 as this cell is the source

void setup() {
    // Set message content
    message.type = NORMAL;
    message.data[0] = level;
    message.crc = message_crc(&amp;message);

    // Set light
    set_color(RGB(3, 3, 3));
}
</code></pre>
<h3 id="other-functions">Other functions</h3>
<p>As said above, the source kilobot really has nothing to do, so the <code>loop()</code> is just empty :</p>
<pre><code class="language-c">void loop() {
    // Nothing to do
}
</code></pre>
<p>The <code>message_tx()</code> function is also quite common :</p>
<pre><code class="language-c">message_t* message_tx() {
    return &amp;message;
}
</code></pre>
<p>And once again, the <code>main()</code> function is nothing new :</p>
<pre><code class="language-c">int main() {
    // initialize hardware
    kilo_init();

    kilo_message_tx = message_tx;

    // start program
    kilo_start(setup, loop);

    return 0;
}
</code></pre>
<hr />
<h2 id="cells-program">Cell's program</h2>
<p>Here's the tough part of the tutorial. Just as the source, the cells will communicate their current level with their neighbors. However, if a cell receive a message from a cell with a level 2 or more times lower than its own, it must update its level.</p>
<h3 id="macros-message-and-setup">Macros, message and <code>setup()</code></h3>
<p>For a better configurability, we will define the <code>MAX_LEVEL</code> and <code>TIMEOUT</code> macros. <code>MAX_LEVEL</code> is the maximum distance level of all cells. <code>TIMEOUT</code> is used to know when to increase the cell's level : if a cell has no news from another cell with a lower level for a long time, it must deduct that it is now further away from the source and update its level accordingly. The <code>timer</code> variable will measure the time since last contact with a lower-level cell.</p>
<pre><code class="language-c">#define MAX_LEVEL 5
#define TIMEOUT 30

message_t message;

int level = MAX_LEVEL;  // The cell starts at MAX_LEVEL
int timer = 0;

void setup() {
    message.type = NORMAL;
}
</code></pre>
<h3 id="sending-and-receiving-messages">Sending and receiving messages</h3>
<p>In <code>message_rx()</code>, the cell analyses messages from its neighbors. If one of its neighbors' level is 2 or more times lower than its own level, it updates. If the level is just under its own, it resets its timer.</p>
<pre><code class="language-c">void message_rx(message_t *m, distance_measurement_t *d) {
    if (m-&gt;data[0] &lt; level-1) {
        // Change level
        level = m-&gt;data[0] + 1;
        timer = 0;
    }
    if (m-&gt;data[0] == level-1) {
        // Reset timer
        timer = 0;
    }
}
</code></pre>
<p>In <code>message_tx()</code>, we update the message content with the current level just before sending the message :</p>
<pre><code class="language-c">message_t* message_tx() {
    message.data[0] = level;
    message.crc = message_crc(&amp;message);
    return &amp;message;
}
</code></pre>
<h3 id="the-loop-function">The <code>loop()</code> function</h3>
<p>Every time we enter the <code>loop()</code>, we increase the timer. If it is above <code>TIMEOUT</code>, we decrement the cell's level.</p>
<p>The cell will also display different shades from green to red depending on its level.</p>
<pre><code class="language-c">void loop() {
    // Update timer
    timer++;
    if (timer &gt;= TIMEOUT &amp;&amp; level &lt; MAX_LEVEL) {
        // Timeout
        level++;
        timer = 0;
    }

    // Set light
    switch (level) {
        case 1:
            set_color(RGB(0, 3, 0));
            delay(50);
            break;
        case 2:
            set_color(RGB(1, 3, 0));
            delay(50);
            break;
        case 3:
            set_color(RGB(3, 3, 0));
            delay(50);
            break;
        case 4:
            set_color(RGB(3, 1, 0));
            delay(50);
            break;
        case MAX_LEVEL:
            set_color(RGB(3, 0, 0));
            delay(50);
            break;
    }
}
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As the <code>TIMEOUT</code> is set to 30 and the <code>loop()</code> takes 50 milliseconds to execute, a timeout take roughly 1,5 seconds to occur.</p>
</div>
<h3 id="put-it-all-together">Put it all together</h3>
<p>Don't forget the <code>main()</code> function!</p>
<pre><code class="language-c">int main() {
    // initialize hardware
    kilo_init();

    kilo_message_rx = message_rx;
    kilo_message_tx = message_tx;

    // start program
    kilo_start(setup, loop);

    return 0;
}
</code></pre>
<hr />
<h2 id="we-are-done">We are done !</h2>
<p>You can now play with the kilobots, moving them around. Try and see what happens when you change the location of the source kilobot. You can also play around with <code>MAX_LEVEL</code> and <code>TIMEOUT</code>, seeing the effects of each change. If you want to go further, why not make the source/cells move randomly? What happens when you have multiple 'source' kilobots? The possibilities are endless.</p>
<hr />
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tuto5.html" class="btn btn-neutral float-right" title="Rush Hour">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="tuto3.html" class="btn btn-neutral" title="King-o-bot's Games"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="tuto3.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="tuto5.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
